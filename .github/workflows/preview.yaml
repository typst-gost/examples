name: build-preview

on:
  push:
    branches:
      - main
    paths:
      - documents/**
      - .github/workflows/**

jobs:
  discover_changed:
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.filter.outputs.folders }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for force rebuild flag
        id: force_check
        run: |
          commit_message=$(git log -1 --pretty=%B)
          if echo "$commit_message" | grep -qi "\[force-rebuild\]"; then
            echo "force_rebuild=true" >> $GITHUB_OUTPUT
            echo "Force rebuild flag detected in commit message"
          else
            echo "force_rebuild=false" >> $GITHUB_OUTPUT
          fi

      - name: Find changed document folders
        id: filter
        run: |
          all_folders=$(find documents -name "main.typ" -type f | xargs dirname | sort)
          changed_files=$(git diff --name-only HEAD~1 HEAD)
          
          echo "Changed files in commit:"
          echo "$changed_files"
          
          force_rebuild="${{ steps.force_check.outputs.force_rebuild }}"
          
          if [ "$force_rebuild" = "true" ]; then
            echo "Force rebuild flag detected - rebuilding ALL documents"
            filtered_folders=$(echo "$all_folders")
          elif echo "$changed_files" | grep -q "^\.github/workflows/"; then
            echo "Workflow changed - rebuilding ALL documents"
            filtered_folders=$(echo "$all_folders")
          else
            filtered_folders=""
            for folder in $all_folders; do
              if echo "$changed_files" | grep -q "^$folder/"; then
                echo "Changes detected in: $folder"
                if [ -n "$filtered_folders" ]; then
                  filtered_folders="$filtered_folders"$'\n'"$folder"
                else
                  filtered_folders="$folder"
                fi
              fi
            done
            
            git fetch origin preview 2>/dev/null || echo "Preview branch does not exist yet"
            
            if git rev-parse --verify origin/preview >/dev/null 2>&1; then
              echo "Checking for new folders not yet in preview branch..."
              for folder in $all_folders; do
                folder_name=$(basename "$folder")
                if ! git ls-tree -r origin/preview --name-only | grep -q "^preview/$folder_name/"; then
                  echo "Folder not found in preview branch (building for first time): $folder"
                  if ! echo "$filtered_folders" | grep -q "^$folder$"; then
                    if [ -n "$filtered_folders" ]; then
                      filtered_folders="$filtered_folders"$'\n'"$folder"
                    else
                      filtered_folders="$folder"
                    fi
                  fi
                fi
              done
            else
              echo "Preview branch doesn't exist, building all documents"
              filtered_folders=$(echo "$all_folders")
            fi
          fi
          
          if [ -z "$filtered_folders" ]; then
            folders_json="[]"
            echo "No folders to build"
          else
            folders_json=$(echo "$filtered_folders" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "Folders to build:"
            echo "$folders_json" | jq .
          fi
          
          echo "folders=$folders_json" >> $GITHUB_OUTPUT

  build_preview:
    needs: discover_changed
    runs-on: ubuntu-latest
    if: needs.discover_changed.outputs.folders != '[]' && needs.discover_changed.outputs.folders != ''
    permissions:
      contents: write
    concurrency:
      group: preview-branch-${{ matrix.folder }}
      cancel-in-progress: false
    strategy:
      matrix:
        folder: ${{ fromJSON(needs.discover_changed.outputs.folders) }}
      max-parallel: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Extract directory info
        run: |
          folder_name=$(basename "${{ matrix.folder }}")
          echo "folder_name=$folder_name" >> $GITHUB_ENV
          echo "output_dir=preview/$folder_name" >> $GITHUB_ENV

      - name: Create output directory
        run: mkdir -p "${{ env.output_dir }}"

      - name: Compile PDF
        uses: docker://ghcr.io/typst/typst:0.14.0
        with:
          args: compile --root . "${{ matrix.folder }}/main.typ" "${{ env.output_dir }}/${{ env.folder_name }}.pdf"

      - name: Compile PNG preview
        uses: docker://ghcr.io/typst/typst:0.14.0
        with:
          args: compile --root . "${{ matrix.folder }}/main.typ" "${{ env.output_dir }}/${{ env.folder_name }}.png" --format png --pages 1 --ppi 300

      - name: Deploy to preview branch
        run: |
          # Save generated files to temporary directory
          temp_dir=$(mktemp -d)
          cp -r "${{ env.output_dir }}" "$temp_dir/"
          
          # Remove the generated files from working directory to avoid conflicts
          rm -rf "${{ env.output_dir }}"
          
          # Fetch preview branch
          git fetch origin preview 2>/dev/null || echo "Preview branch does not exist"
          
          # Switch to preview branch
          if git rev-parse --verify origin/preview >/dev/null 2>&1; then
            git checkout -B preview origin/preview
          else
            git checkout --orphan preview
            git rm -rf . 2>/dev/null || true
          fi
          
          # Copy files from temporary directory
          mkdir -p "$(dirname "${{ env.output_dir }}")"
          cp -r "$temp_dir/$(basename "${{ env.output_dir }}")" "$(dirname "${{ env.output_dir }}")/"
          
          # Add and commit
          git add -f "${{ env.output_dir }}/"*
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update preview for ${{ matrix.folder }}"
            git push origin preview
          fi
